# B2B Crypto Wallet API

## Project Description

This project implements a REST API server for managing cryptocurrency wallets and transactions, built using Django and Django REST Framework. The API supports pagination, sorting, and filtering for both `Wallet` and `Transaction` models, while enforcing strict balance control and adhering to the JSON:API specification.

### Key Features:

* **Wallet Model:** `id`, `label`, `balance`.

* **Transaction Model:** `id`, `wallet_id` (foreign key), `txid`, `amount`, `timestamp`.

* **Unique Transaction ID (`txid`):** `txid` is a required and unique string field for each transaction.

* **High Precision Amounts:** `amount` field supports 18-digit precision and can be negative (for withdrawals).

* **Non-Negative Wallet Balance:** The `balance` of a wallet is a sum of all its transactions' amounts and **must NEVER be negative**. This is strictly enforced through atomic database operations (`select_for_update`) and model-level validation (`clean()` and `delete()` methods).

* **JSON:API Compliance:** The API adheres to the JSON:API specification, ensuring structured and predictable request/response formats. This is achieved using `djangorestframework-jsonapi`.

* **API Functionalities:**

    * **Pagination:** Responses are paginated (Limit/Offset style).

    * **Sorting:** Clients can sort results by various fields (e.g., `label`, `balance` for wallets; `amount`, `timestamp` for transactions).

    * **Filtering:** Comprehensive filtering capabilities are provided (e.g., by `label` for wallets; by `wallet_id`, `txid`, `amount` ranges, `timestamp` ranges for transactions).

    * **Search:** Basic search functionality is available.

* **Immutable Transactions:** Transactions are treated as immutable records. Once created, they cannot be updated (`PATCH`/`PUT` methods are explicitly disabled). Incorrect transactions should be compensated by new, correcting transactions.

* **Robust Error Handling:** Model-level validation errors (e.g., negative balance) are caught and returned as JSON:API compliant error objects (`400 Bad Request`).

* **API Documentation:** Interactive API documentation is provided via Swagger UI (generated by `drf-spectacular`).

* **Database:** PostgreSQL for robust data storage.

* **Containerization:** Docker and Docker Compose for easy setup and consistent development/production environments.

* **Code Quality:** Utilizes linters (`flake8`, `black`) and static type checking (`mypy`) to maintain high code quality and consistency.

* **Test Coverage:** Includes comprehensive unit and integration tests for models and API endpoints.

## Tech Stack

* Python 3.11+

* Django 4.2+

* Django REST Framework 3.15+

* djangorestframework-jsonapi 8.0.0

* django-filter 24.2

* drf-spectacular 0.27.0

* drf-spectacular-json-api 1.0.0

* psycopg2-binary (PostgreSQL adapter)

* gunicorn (WSGI HTTP Server)

* flake8, black, mypy (Linters & Type Checker)

* PostgreSQL 15 (Database)

* Docker & Docker Compose

## Quick Start (Using Docker Compose)

Follow these steps to get the application up and running quickly on your local machine.

### Prerequisites:

* Docker Desktop (or Docker Engine and Docker Compose) installed on your system.

### Steps:

1.  **Clone the Repository:**

    ```bash
    git clone [https://github.com/.../b2b-crypto-wallet.git]
    cd b2b-crypto-wallet
    ```

2.  **Create the `.env` file:**
    Create a file named `.env` in the root directory of the project (next to `docker-compose.yml`) and add the following environment variables. **It is crucial to change the values for `SECRET_KEY` and `POSTGRES_PASSWORD` to strong, unique values for production environments!**

    ```
    POSTGRES_DB=b2b_wallet_db
    POSTGRES_USER=b2b_user
    POSTGRES_PASSWORD=b2b_password
    DB_HOST=db
    DB_PORT=5432

    SECRET_KEY=your_very_secret_key_here_please_change_this_in_production
    DEBUG=1
    ALLOWED_HOSTS=localhost,127.0.0.1
    ```

3.  **Launch Docker Compose:**
    This command will build the Docker images (if they don't exist or have changed) and start all services defined in `docker-compose.yml` (the web application and the database).

    ```bash
    docker-compose up --build -d
    ```

    * `--build`: Instructs Docker to rebuild images, which is necessary when `Dockerfile` or `requirements.txt` change.

    * `-d`: Runs the containers in detached mode (in the background).

4.  **Check Container Status:**
    Verify that all containers are running:

    ```bash
    docker-compose ps
    ```

    You should see `Up` status for both `django_gunicorn` and `db` services.

5.  **Access the API:**
    Your API should now be accessible at: `http://localhost:8000/api/`

## API Endpoints

The API adheres to the JSON:API specification.

### Wallets

* **List all wallets:**
    `GET /api/wallets/`

    * **Pagination:** Use `page[number]` and `page[size]` query parameters.
        Example: `GET /api/wallets/?page[number]=2&page[size]=10`

    * **Sorting:** Use the `sort` parameter.
        Example: `GET /api/wallets/?sort=-balance` (sort by balance descending)
        Example: `GET /api/wallets/?sort=label` (sort by label ascending)

    * **Filtering:**
        Example: `GET /api/wallets/?filter[label.icontains]=MyWallet` (case-insensitive partial match)
        Example: `GET /api/wallets/?filter[balance_gt]=100` (wallets with balance > 100)

* **Retrieve a single wallet:**
    `GET /api/wallets/{id}/`

* **Create a new wallet:**
    `POST /api/wallets/`

    * **Example Request Body (JSON:API):**

        ```json
        {
          "data": {
            "type": "wallets",
            "attributes": {
              "label": "My New Wallet"
            }
          }
        }
        ```

* **Update an existing wallet:**
    `PATCH /api/wallets/{id}/`

    * **Example Request Body (JSON:API, to change label):**

        ```json
        {
          "data": {
            "type": "wallets",
            "id": "1",
            "attributes": {
              "label": "Updated Wallet Label"
            }
          }
        }
        ```

* **Delete a wallet:**
    `DELETE /api/wallets/{id}/`

### Transactions

* **List all transactions:**
    `GET /api/transactions/`

    * **Pagination:** Use `page[number]` and `page[size]` query parameters.

    * **Sorting:** Use the `sort` parameter.
        Example: `GET /api/transactions/?sort=-amount` (sort by amount descending)

    * **Filtering:**

        * By `wallet_id`: `GET /api/transactions/?filter[wallet]=<wallet_id>`

        * By `txid`: `GET /api/transactions/?filter[txid.icontains]=unique-transaction-id-123`

        * By `amount` range: `GET /api/transactions/?filter[amount_gte]=100&filter[amount_lte]=500`

        * By `timestamp` range: `GET /api/transactions/?filter[timestamp_gte]=2023-01-01T00:00:00Z`

* **Retrieve a single transaction:**
    `GET /api/transactions/{id}/`

* **Create a new transaction:**
    `POST /api/transactions/`

    * **Important:** Wallet balance validation occurs. If the transaction leads to a negative balance, it will be rejected.

    * **Example Request Body (JSON:API):**

        ```json
        {
          "data": {
            "type": "transactions",
            "attributes": {
              "txid": "unique-txn-12345",
              "amount": "100.50"
            },
            "relationships": {
              "wallet": {
                "data": {
                  "type": "wallets",
                  "id": "<wallet_id>"
                }
              }
            }
          }
        }
        ```

* **Update an existing transaction:**
    `PATCH /api/transactions/{id}/` and `PUT /api/transactions/{id}/` methods are **disabled** for transactions as they are treated as immutable records.

* **Delete a transaction:**
    `DELETE /api/transactions/{id}/`

    * **Important:** Deleting a transaction also triggers balance validation. If deletion would lead to a negative balance, it will be rejected.

### API Documentation (Swagger UI / OpenAPI)

* **OpenAPI Schema (JSON):** `http://localhost:8000/api/schema/`

* **Swagger UI:** `http://localhost:8000/api/schema/swagger-ui/`

* **Redoc:** `http://localhost:8000/api/schema/redoc/`

## Running Tests

You can run tests directly inside the `django_gunicorn` Docker container.

```bash
  docker-compose exec django_gunicorn python manage.py test
```

## Running Linters

You can run linters either directly in your local terminal (within your virtual environment) 

### Running Flake8 (code style check):

```bash
  flake8
```

### Running Mypy (static type checking):

```bash
  mypy .
```